name: "CI"
on: ["push", "pull_request"]

jobs:
  windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
    # Install general deps
    - name: "Install msys2"
      uses: msys2/setup-msys2@v2
      with:
          install: pacman-mirrors pkg-config base-devel mingw-w64-x86_64-toolchain mingw-w64-x86_64-go upx mingw-w64-x86_64-dlfcn unzip git tar
          update: false

    - name: "Installing Erlang"
      run: |
        git clone https://github.com/asdf-vm/asdf.git ~/.asdf
        . $HOME/.asdf/asdf.sh
        # echo "$HOME/.asdf/bin" >> $GITHUB_PATH
        # echo "$HOME/.asdf/shims" >> $GITHUB_PATH
        asdf plugin add erlang
        asdf plugin add elixir
        echo "erlang 25.0.4" >> .tool-versions
        echo "elixir 1.13.4-otp-25" >> .tool-versions
        asdf install
    # - run: choco install erlang
    #   shell: powershell

    - uses: actions/checkout@v1
    - run: |
        . $HOME/.asdf/asdf.sh
        mix local.hex --force
        mix local.rebar --force
        mix deps.get
        mix lint

    - name: "Build Release"
      run: |
        . $HOME/.asdf/asdf.sh
        mix desktop.installer

    - name: Archive Installer
      uses: actions/upload-artifact@v2
      with:
        name: Windows-Installer
        path: _build/prod/*.exe

  linux:
    runs-on: ubuntu-20.04
    steps:
    # Install general deps
    - name: "Installing Erlang"
      run: |
        git clone https://github.com/asdf-vm/asdf.git ~/.asdf
        . $HOME/.asdf/asdf.sh
        # echo "$HOME/.asdf/bin" >> $GITHUB_PATH
        # echo "$HOME/.asdf/shims" >> $GITHUB_PATH
        asdf plugin add erlang
        asdf plugin add elixir
        echo "erlang 25.0.4" >> .tool-versions
        echo "elixir 1.13.4-otp-25" >> .tool-versions
        asdf install

    - uses: actions/checkout@v1
    - name: "Compile and Lint"
      run: |
        . $HOME/.asdf/asdf.sh
        mix local.hex --force
        mix local.rebar --force
        mix deps.get
        mix lint

    - name: "Build Release"
      run: |
        . $HOME/.asdf/asdf.sh
        mix desktop.installer

    - name: Archive Linux Installer
      uses: actions/upload-artifact@v2
      with:
        name: Linux-Installer
        path: _build/prod/*.run
    # - name: Linux Release
    #   uses: softprops/action-gh-release@v1
    #   if: startsWith(github.ref, 'refs/tags/')
    #   with:
    #     files: _build/*.run

  macos:
    runs-on: macos-11
    steps:
    # Install general deps
    - name: "Install brew deps"
      run: |
          brew install binutils coreutils wget erlang

    - name: "Installing Erlang"
      run: |
        git clone https://github.com/asdf-vm/asdf.git ~/.asdf
        . $HOME/.asdf/asdf.sh
        # echo "$HOME/.asdf/bin" >> $GITHUB_PATH
        # echo "$HOME/.asdf/shims" >> $GITHUB_PATH
        asdf plugin add erlang
        asdf plugin add elixir
        echo "erlang 25.0.4" >> .tool-versions
        echo "elixir 1.13.4-otp-25" >> .tool-versions
        asdf install
    
    - uses: actions/checkout@v1
    - name: "Compile and Lint"
      run: |
        . $HOME/.asdf/asdf.sh
        mix local.hex --force
        mix local.rebar --force
        mix deps.get
        mix lint

    - name: "Build Release"
      run: |
        . $HOME/.asdf/asdf.sh
        mix desktop.installer

    - name: Archive MacOS Installer
      uses: actions/upload-artifact@v2
      with:
        name: MacOS-Installer
        path: _build/prod/*.dmg
